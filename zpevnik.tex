\special{papersize=297mm,210mm}
%\pdfcompresslevel=9
%\pdfobjcompresslevel=9
\hsize=297mm
\vsize=210mm
\pdfpagewidth=29.7cm
\pdfpageheight=21cm
\errorcontextlines=0
\divide\hsize by 2
\advance\hsize by -3cm
\advance\vsize by -2cm
\advance\hoffset by -1in
\advance\voffset by -1in

\long\def\gray#1{\special{pdf: bc [ 0 0 0 0.1 ]}#1\special{pdf: ec}}

\newbox\voditka
\setbox\voditka=\hbox to 0pt{\vbox to 210mm{
  \vss\hbox{\hskip 2mm}\gray{
    \hrule
    \vskip 45mm\hrule
    \vskip 65mm\hrule
    \vskip 45mm\hrule
    \vskip 20mm
  }}\hss}

\newif\ifhalf\halffalse
\newif\ifspoj\spojfalse
\newbox\Lbox
\newbox\LLbox

\ifhalf
  \special{papersize=148.5mm,210mm}
  \divide\pdfpagewidth by 2
  \output{\shipout\hbox{\vsize=210mm\hskip 2mm\copy\voditka\hskip 25mm%
    \vbox{\box255\vskip 7mm}\hskip 5mm}\global\advance\pageno by 1}
\else
  \output{%
    \if\botmark K
      \ifvoid\LLbox
        \ifvoid\Lbox
% Jednostranná písnička, nic na zásobníku
          \global\setbox\Lbox=\box255
        \else
% Dvě jednostranné písničky
          \shipout\hbox{\vsize=210mm\copy\voditka\hskip 25mm\vbox{\box\Lbox\vskip 7mm}%
            \hskip 5mm\gray{\vrule\hskip-0.4pt\copy\voditka}%
            \hskip 25mm\vbox{\box255\vskip 7mm}\hskip 5mm%\vrule
          }\global\advance\pageno by 1
        \fi
      \else
% Dvoustranná písnička; případný zásobník (Lbox) odložíme na příště
        \shipout\hbox{\vsize=210mm\copy\voditka\hskip 25mm\vbox{\box\LLbox\vskip 7mm}%
          \hskip 5mm\hbox to 0pt{\hss \special{pdf: epdf (otoc-1.pdf)}\hskip 1cm}%
          \hskip 25mm\vbox{\box255\vskip 7mm}\hskip 5mm%\vrule
        }\global\advance\pageno by 1
      \fi
    \else
% První strana dvoustranné písničky: na 2. level zásobníku (LLbox)
      \ifvoid\LLbox
        \global\setbox\LLbox=\box255
      \else
% Druhá strana a pořád ne poslení
        \errmessage{Písnička má více než dvě strany}
        \setbox0=\box\LLbox
        \setbox0=\box255
      \fi
    \fi
  }
\fi

\let\oldeject=\eject
\def\eject{\ifspoj\spojfalse\else\mark{K}\fi\oldeject}
\let\spoj=\spojtrue

\parindent=0pt
\parskip=2pt plus 1pt minus 2pt

\font\tako="Myriad Pro/B" at 9pt % Akordy text, script, sscript
\font\sako="Myriad Pro/B" at 7pt
\font\ssako="Myriad Pro/B" at 5pt
\newfam\ako
\textfont\ako=\tako
\scriptfont\ako=\sako
\scriptscriptfont\ako=\ssako

\font\trm="Minion Pro" at 11pt % Text písniček
\font\tit="Minion Pro/I" at 11pt % Text písniček
\font\ti=cmmib10 % Pro hvězdičku, křížek a béčko
\font\tsy=cmsy10 at 11pt
\font\srm=pncr8z at 9pt
\font\si=cmmib9
\font\ssy=cmsy9
\font\ssrm=pncr8z at 6pt
\font\ssi=cmmib6
\font\sssy=cmsy6
\textfont0=\trm\scriptfont0=\srm\scriptscriptfont0=\ssrm
\textfont1=\ti\scriptfont1=\si\scriptscriptfont1=\ssi
\textfont2=\tsy\scriptfont2=\ssy\scriptscriptfont2=\sssy
\def\rm{\fam0\trm}
\def\sl{\fam0\tit}
\def\it{\fam0\tit}
\baselineskip=12pt plus 1.5pt minus 1.5pt
\rm

\font\napisfont="Minion Pro/B" at 11pt
\font\autor="Myriad Pro Semibold/I" at 13pt
\font\nazev="Myriad Pro Semibold" at 16pt

% Kategorie znaků

\let\2=2
\let\4=4
\let\6=6
\let\7=7
\let\9=9
\let\+=+
\def\akocats{%    % V akordech:
  \catcode`\#=13  % # = křížek
  \catcode`\b=13  % b = béčko
  \catcode`\ =13  % mezery zachovávat, přestože jsme v mat. režimu
  \catcode`\2=13
  \catcode`\4=13
  \catcode`\6=13
  \catcode`\7=13
  \catcode`\9=13
  \catcode`\+=13
  \let\gl\global
  \let\space\ }
{\akocats
  \gl\let#=\sharp
  \gl\letb=\flat
  \gl\def2{{^\2}}%
  \gl\def4{{^\4}}%
  \gl\def6{{^\6}}%
  \gl\def7{{^\7}}%
  \gl\def9{{^\9}}%
  \gl\def+{{^\+}}
  \gl\def {\mskip8mu}}
\def\maj{^{maj}}
\def\dim{^{dim}}
\def\x{×}

\let\align=&
\let\|=|
\let\[=[
\let\]=]
\catcode`\[=13                  % Aktivní znaky (význam následuje):
\catcode`\]=13                  % hranaté závorky - pro akordy
\catcode`\"=13                  % uvozovky, aby byly dle českých pravidel
\catcode`\|=13                  % pro repetice zapsané |:abc:|
\catcode`\&=13                  % pro "Žalman & spol." a podobné
\let&=\&
\def\head#1#2\empty{#1}
\def\tail#1#2\empty{#2}
\def]#1]{\leavevmode\expandafter\if\head#1\empty\empty*%
$\fam\ako\tail#1\empty$\egroup
\else%
\raise 1.2em\hbox to 0pt{$\fam\ako#1$\hss}\egroup
\fi}
\def[{\bgroup\akocats]}
\def\\{\hfil\vadjust{\nobreak}\break\null\ignorespaces}
\def\zuv{„\let"=\kuv}
\def\kuv{“\let"=\zuv}
\let"=\zuv
%\def"#1"{„#1“}
\def\dtend#1{\hskip2pt:\|\hskip-1pt\|\global\catcode`\|=13\global\catcode`\:=12\relax}
\def\dtrozhodni{\if\dtnext\|\let\after\dtend\else\let\after\relax\fi\after}
{\catcode`\:=13
  \global\def:{\futurelet\dtnext\dtrozhodni}}
\def|:{\|\hskip-1pt\|:\hskip2pt\global\catcode`\:=13\global\catcode`\|=12\relax}

% Sloky, refrény apod.

\def\gobble#1{}

\newcount\snum
\def\napis#1{\vskip 10pt\penalty -100\noindent\hbox to 0pt{\kern 
-1in\hss\napisfont#1\kern8pt}\ignorespaces\gobble}
\def\sloka{\global\advance\snum by 1\napis{\the\snum.}}
\def\ref{\napis{Ref.}}
\def\rec{\napis{Rec.}}
\let\jine=\napis
\def\hvezda{\jine{$\star$.}}

\def\zlom{\vfil\break}
\def\oddel{\vskip 5pt plus 1pt minus 1pt\nobreak}

\newwrite\seznam
\immediate\openout\seznam=seznam.tex

\def\kap#1{\vfill\eject
  \immediate\write\seznam{\special{pdf: out 1 \noexpand<\noexpand< /Title (#1) /Dest \noexpand[
@page\the\pageno\space /Fit \noexpand] >>}}}
\def\podkap#1{\vfill\eject
  \immediate\write\seznam{\special{pdf: out 2 \noexpand<\noexpand< /Title (#1) /Dest \noexpand[
@page\the\pageno\space /Fit \noexpand] >>}}}

\def\pisen#1#2{\vfill\eject\snum=0
  \mark{Z}
  \immediate\write\seznam{\special{pdf: out 3 \noexpand<\noexpand< /Title (#2) /Dest \noexpand[
@page\the\pageno\space /Fit \noexpand] >>}}
  \vbox to 1cm{\vss\parindent=-20pt
  {\vrule width 0pt depth 2pt height 10pt \autor #1}\par
  {\vrule width 0pt depth 3pt height 15pt \nazev #2}\par\vskip 10pt
  }\vskip-10pt}

\def\bye{%
  \immediate\closeout\seznam\catcode`[=12\catcode`]=12\catcode`\<=12\catcode`\>=12\input seznam%
  \par\vfill\eject
  \ifvoid\Lbox\else\null\vfill\eject\fi
  \end}

%%%%% Pro kompatibilitu s TP zpěvníkem

\catcode`\<=13
\catcode`\>=13
\def<{\bgroup\akocats>}
\def>#1>{]#1]}
\def\zp#1#2{\pisen{#2}{#1}}
\let\zs=\sloka
\let\zr=\ref
\let\ks=\relax
\let\kr=\relax
\let\kp=\relax

\catcode`'=13
\let'=’

\frenchspacing
\obeylines
